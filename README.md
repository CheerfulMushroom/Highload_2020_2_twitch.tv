
# Highload_2020_2_twitch.tv
Расчётно-пояснительная записка для twitch.tv

## Содержание:
1.  [Выбор темы](#1--выбор-темы)
2.  [Определение возможного диапазона нагрузок подобного проекта](#2-определение-возможного-диапазона-нагрузок-подобного-проекта)
3.  [Выбор планируемой нагрузки](#3-выбор-планируемой-нагрузки)
4.  [Логическая схема базы данных (без выбора СУБД)](#4-логическая-схема-базы-данных-без-выбора-субд)
5.  [Физическая системы хранения (конкретные СУБД, шардинг, расчет нагрузки, обоснование реализуемости на основе результатов нагрузочного тестирования)](#5-физическая-системы-хранения-конкретные-субд-шардинг-расчет-нагрузки-обоснование-реализуемости-на-основе-результатов-нагрузочного-тестирования)
6.  [Выбор прочих технологий: языки программирования, фреймфорки, протоколы взаимодействия, веб-сервера и т.д. (с обоcнованием выбора)](#6-выбор-прочих-технологий-языки-программирования-фреймфорки-протоколы-взаимодействия-веб-сервера-и-тд-с-обоcнованием-выбора)
7.  [Расчет нагрузки и потребного оборудования](#7-расчет-нагрузки-и-потребного-оборудования)
8.  [Выбор хостинга / облачного провайдера и расположения серверов](#8-выбор-хостинга--облачного-провайдера-и-расположения-серверов)
9.  [Схема балансировки нагрузки (входящего трафика и внутрипроектного, терминация SSL)](#9-схема-балансировки-нагрузки-входящего-трафика-и-внутрипроектного-терминация-ssl)
10. [Обеспечение отказоустойчивости](#10-обеспечение-отказоустойчивости)


## 1.  Выбор темы
Стриминг видео на twitch.tv


## 2. Определение возможного диапазона нагрузок подобного проекта

По данным [[1]](https://twitchtracker.com/statistics) на 07.10.2020 было известно следующее:
|     | Одновременных зрителей, млн | Одновременных стримов, тыс. | Суммарное время просмотра в день, млн ч. |
|-----|------------------------------|----------------------------|------------------------------------------|
| min | 1.2                          | 40                         | 51                                       |
| max | 3.5                          | 185                        | 57                                       |


### Зритель

Скорость загрузки видео зрителем  
| Качество | FPS | Скорость, МБ/с   | Предполагаемое распределение, % |
|----------|-----|------------------|---------------------------------|
| 1080     | 60  | 0.75             | 24                              |
| 720      | 60  | 0,56             | 27                              |
| 720      | 30  | 0,28             | 22                              |
| 480      | 30  | 0,19             | 15                              |
| 360      | 30  | 0,09             | 9                               |
| 160      | 30  | 0,035            | 3                               |


Т.о.,  
Средняя скорость скачивания видео зрителем =  0,75\*0.24 + 0,56\*0.27 + 0,28\*0.22 + 0,19\*0.15 + 0,09\*0.09 + 0,035\*0.03 = **0,43 МБ/с**  
**Минимальная** скорость скачивания видео **зрителями** = 0,43 МБ/с \* 1.2 млн = **4128 Гбит/с**  
**Пиковая** скорость скачивания видео **зрителями** = 3.72 Мбит/с \* 3.5 млн = **12040 Гбит/с**  

### Стример

Скорость загрузки видео стримерами [[2]](https://stream.twitch.tv/encoding/)  
| Качество | FPS | Скорость, Мбит/с | Предполагаемое распределение, % |
|----------|-----|------------------|---------------------------------|
| 1080     | 60  | 0,75             | 20                              |
| 1080     | 30  | 0,56             | 25                              |
| 720      | 60  | 0,56             | 20                              |
| 720      | 30  | 0,28             | 35                              |


Т.о.  
Средняя скорость загрузки видео стримером = 0,75\*0.20 + 0,56\*0.25 + 0,56\*0.20 + 0,28\*0.35 = **0,5 МБ/с**  
**Минимальная** скорость загрузки видео **стримерами** = 0,5 МБ/с \* 40 тыс. = **160 Гбит/с**  
**Пиковая** скорость загрузки видео **стримерами** = 0,5 МБ/с \* 185 тыс. = **736 Гбит/с**  

### Транскодер

Скорость выдачи транскодером видео
| Качество | FPS | Скорость выходного потока, МБ/с |
|----------|-----|---------------------------------|
| 1080     | 60  | 1.85                            |
| 1080     | 30  | 1.1                             |
| 720      | 60  | 1.1                             |
| 720      | 30  | 0.595                           |


Т.о.  
Средняя скорость выходного потока транскодера = 1.85\*0.20 + 1.1\*0.25 + 1.1\*0.20 + 0.595\*0.35 = **1,07 МБ/с**  
**Минимальная** скорость выходного потока = 1,07 МБ/с \* 40 тыс. = **344 Гбит/с**  
**Пиковая** скорость выходного потока = 1,07 МБ/с \* 185 тыс. = **1600 Гбит/с**  


## 3. Выбор планируемой нагрузки
Аналогичная twitch.tv

## 4. Логическая схема базы данных (без выбора СУБД)
![Database without DBMS](readme_images/db_no_dbms.png)  

## 5. Физическая системы хранения (конкретные СУБД, шардинг, расчет нагрузки, обоснование реализуемости на основе результатов нагрузочного тестирования)
### Расчёт нагрузки и выбор СУБД
Нагрузка на БД будет состоять из нескольких частей:

- (FRONTEND) Получение информации о пользователе при входе на сайт.  
Самый большой прирост зрителей на сайте составляет 170тыс. за 10 минут.    
Т.о запросов в базу за информацией о пользователе = 170000 / 60 = **283 rps**  
Для кэширования информации о количестве зрителей можно использовать Memcached, а сами счётчики хранить в PostgreSql  

- (FRONTEND) Получение данных о стриме, когда пользователь его включает (один раз):  
Самый большой прирост зрителей на 3.10.2020 за 10 минут составляет приблизительно 80тыс.[[3]](https://twitchtracker.com/statistics)  
Т.о. **пиковое** количество запросов за информацией о стриме от людей, включающих стрим = 80000 / (10\*60) = **133 rps**  
Для этого вполне подойдёт PostgreSql  

- (FRONTEND) В случае онлайн трансляции будет также получение информации о нынешнем количестве пользователей. Данная информация не является критической и может кэшироваться, например, на 1 минуту.  
Наибольшее количество стримов одновременно = 185тыс. [[4]](https://twitchtracker.com/statistics)  
Т.о запросов в базу за количеством пользователей = 185000 / 60 = **3083 rps**  
Для кэширования информации о количестве зрителей можно использовать Memcached, а сами счётчики хранить в PostgreSql  

- (INGEST SERVERS) Проверка stream-key для определения того, куда перенаправить видеопоток стримера. Получение stream-key будет производиться только один раз при начале трансляции.  
Наибольший прирост стримов за 10 минут на 21.10.2020 = 7тыс. [[5]](https://twitchtracker.com/statistics)  
Т.о. запрсов в базу за валидацией stream-key = 7000 / (10\*60) = **12 rps**  
Для этого вполне подойдёт PostgreSql  


Итого:  
запросов в Postgresql - **428** rps  
запросов в Memcahced - **3083** rps  

### Расчёт объёма данных в СУБД  

#### PostgreSQL  
- users  
Одна запись в таблице users = id(8) + username(25) + mail(64) + password(32) + avatar_link(64) + 
verified(1) + followers_count(8) + created_at(8) + current_stream_id(8) + stream_key(64) = 282 Б  
Зная, что максимальное количество уникальных зрителей в месяц равно 140млн [[6]](https://www.businessofapps.com/data/twitch-statistics/), можно принять, что всего записей будет порядка 200 млн  
Т.о. вес таблицы users = 282 \* 200e6 = 564e8 Б = **56.4 ГБ**  

- streams
Одна запись в таблице streams = channel_id(8) + id(8) + name(64) + started_at(8) + master_playlist(128) + unique_viewers_count(8) + online_viewers_count(8) = 232 Б  
Зная, что каждый день максимальное количество стримов варьируется от 70тыс. до 185тыс., можно предположить, что каждый день проходит порядка 200-250тыс. стримов. Примем, что каждый день проходит *250тыс.* стримов.  
Также примем, что 70% из них сохраняется в архив на 14 дней.  
Т.о. вес таблицы streams = 232 \* 250e3 \* 14 = 812e6 Б = **0.812 ГБ**  

- transcoders_links  
Одна запись в таблице transcoders_links = stream_key(64) + transcoder_link(64) = 128 Б  
Для одного стрима выделяется один канал транскодер, то в таблице будет максимум, т.е. одна зщапись в таблице.  
Наибольшее количество стримов одновременно = 185тыс.  
Т.о. вес таблицы transcoders_links = 128 \* 185e3 \* 14 = 812e6 Б = **23,7 МБ**  


#### Memcached
- Как уже былдо сказано, наибольшее количество стримов одновременно = 185тыс  
Т.о., придётся хранить id стрима (8 байт) и количество зрителей онлайн (8 байт), т.е. 16 байт на запись  
Т.о., все счётчики будут занимать в памяти: 8 \* 185e3 = 1,48 МБ

### Расчёт объёма данных в архивах

Всего в месяц стримится порядка 75млн (в неделю ~ 19 млн. ч.). часов видео. Допустим, что из них сохраняется 70% контента на неделю.  


| Качество | FPS | Вес часа стрима, ГБ | Всего часов в неделю в таком качестве, млн. ч | Всего места занимает, ПБ | Место с учётом процента хранимых стримов, ПБ |
|----------|-----|---------------------|-----------------------------------------------|--------------------------|----------------------------------------------|
| 1080     | 60  | 6.7                 | 3.8                                           | 25.5                     | 17.9                                         |
| 1080     | 30  | 4                   | 4.7                                           | 18.8                     | 13.2                                         |
| 720      | 60  | 4                   | 3.8                                           | 15.2                     | 10.7                                         |
| 720      | 30  | 2.1                 | 6.7                                           | 14.1                     | 9.87                                         |  

Отсюда следует, что для хранения архива нам понадобиться приблизительно 52ПБ места

Примем, что 30% зрителей смотрят записи из архива. Тогда в пиковой нагрузке на сайте присутствует 3,5 млн. пользователей, а записи смотрит 1,05 млн.  
Отсюда следует, что пиковая скорость скачивания видео из архива: 1,05e6 \* 0.43МБ/с = 0,45e6МБ/с = **3600Гбит/с**  


### Расчёт данных, хранимых на edge-серверах

## 6. Выбор прочих технологий: языки программирования, фреймфорки, протоколы взаимодействия, веб-сервера и т.д. (с обоcнованием выбора)

### Бэкенд
Go (хорошая утилизация ресурсов сервера)  
Nginx - отдачи кусочков стрима c серверов статики  
Отдача стримов(поддержка автоматической смены качества, нативная поддержка браузерами и некоторыми другими устройствами (например, теми, которые используют chromecast))  
AWS Elemental MediaLive для преобразования RTMP потока в HLS потоки разного качества и с различным FPS  

### Web клиент (зритель)
Javascript

### Клиент стримера:  
Передача стримов по протоколу RTMP  
Передачу данных по этому протоколу поддерживает множество приложений для стримов, наиболее популярным из которых является OBS  

## 7. Расчет нагрузки и потребного оборудования

### БД  
Как уже было сказано, для хранения информации о пользователях, стримах и доступных транскодерах нам потребуется \~60 ГБ свободного места. Мы также должны обеспечить для них репликацию мастер-слейв. Т.о. нам понадобиться 3 сервера по 57ГБ свободного места. Суммарная нагрузка на мастера ожидается порядка 450 rps.  

Для кэширования информации о количестве зрителей также отдельно будем использовать memcached, на который будет приходить порядка 3100 rps.  

### Архив  
Для хранения архива нам понадобится 52ПБ. Также будем хранить по 2 реплики на каждый сервер. Если в каждый сервер вставить по 90 дисков на 20 ТБ, то нам понадобится 30 серверов. С учётом реплик - 90. Скачиваться данные с архива будут со скорость *2,31 Гбит/с*.  
Средняя скорость получения транскодированного видео = (1.85\*0.20 + 1.1\*0.25 + 1.1\*0.20 + 0.595\*0.35) = **1,1МБ/с** 
Загружаться видео в архив будут со скоростью  
185e3 \* 1,1 = 204000 МБ/с = **1632 Гбит/с**

### Edge-сервера  
Через edge сервера будет производиться распространения live контента от транскодеров ко зрителям. Наибольшее количество стримов одновременно 185тыс. 

## 8. Выбор хостинга / облачного провайдера и расположения серверов
По данным SimilarWeb[[7]](./audience-geography.pdf) можно установить следующее использование сервиса по географии:  
- 40% - страны Европы, включая Россию  
- 30% - страны Северной Америки (США, Канада, Мескика)  
- 25% - страны Азии  
- 5% - Австралия и страны тихого океана  
- 5% - страны Южной Америки (Бразилия, ...)  


## 9. Схема балансировки нагрузки (входящего трафика и внутрипроектного, терминация SSL)


## 10. Обеспечение отказоустойчивости

Расчёт стоимости для 1080p 60fps для США (без зарезервированного канала):  
Входной поток - HD, 10-20 Мбит/с = 0,1764 $/час  
Выходные потоки:  
1080p 60fps = 0,3312 $/час  
720p 60fps  = 0,2628 $/час  
720p 30fps  = 0,2124 $/час  
480p 30fps  = 0,2124 $/час  
360p 30fps  = 0,2124 $/час  
160p 30fps  = 0,2124 $/час  
Итого: 0,1764 + 0,3312 + 0,2628 + 0,2124 \* 4 = 1,38348 $/час

Расчёт стоимости для 1080p 60fps для США (c зарезервированным каналом):  
Входной поток - HD, 10-20 Мбит/с = 0,0427 $/час  
Выходные потоки:  
1080p 60fps = 0,0805 $/час  
720p 60fps  = 0,0649 $/час  
720p 30fps  = 0,0518 $/час  
480p 30fps  = 0,0518 $/час  
360p 30fps  = 0,0518 $/час  
160p 30fps  = 0,0518 $/час  
Итого: 0,0427 + 0,0805 + 0,0649 + 0,0518 \* 4 = 0.3953 $/час


Распределение по географии:  
- Северная Америка (35%):  
	- 32% - США  
	- 3% - канада
- Южная Америка (4%):  
	- 3% - Бразилия  
	- 1% - Аргентина
- Европа (37%):  
	- 8% - Германия  
	- 7% - Англия  
	...
	- 2% - Россия  
- Страны западной азии (5%)  
- Страны восточной азии (5.6%):  
	- 4% - Южная корея  
	- 1.6% - Япония  
- Австралия (1,6%)  
